C251 COMPILER V5.60.0,  uart1                                                              18/05/23  11:00:22  PAGE 1   


C251 COMPILER V5.60.0, COMPILATION OF MODULE uart1
OBJECT MODULE PLACED IN .\Objects\uart1.obj
COMPILER INVOKED BY: E:\Keil_v5\C251\BIN\C251.EXE uart1.c INTR2 BROWSE DEBUG PRINT(.\Listings\uart1.lst) OBJECT(.\Object
                    -s\uart1.obj) 

stmt  level    source

    1          #include "uart1.h" 
    2          #include "delay.h" 
    3          /*--------------------------------------------------------------*/
    4          /* --- -----------------实验内容 -------------------------------*/
    5          /* --- 1-了解STC-ISP工具生产延时函数方法 -----------------------*/
    6          /* --- 2-掌握子函数的创建与调用---------------------------------*/
    7          /* --- 实验平台：未来电子STC32核心板----------------------------*/
    8          /* --- 视频学习：https://space.bilibili.com/494969171 ----------*/
    9          /* --- QQ交流群：702805632 -------------------------------------*/
   10          /* --- 参考资料：STC32实验室参考例程 ---------------------------*/
   11          /*--------------------------------------------------------------*/
   12          
   13          bit B_TX1_Busy; //发送忙标志
   14          
   15          /***************************************************************************
   16           * 描  述 : 串口1初始化函数
   17           * 入  参 : 无
   18           * 返回值 : 无
   19          备注：波特率9600bps   晶振24MHz
   20           **************************************************************************/
   21          void Uart1_Init(void)
   22          {        
   23   1              P3M1 &= 0xFC;   P3M0 &= 0xFC;                     //设置P3.0 ,P3.1为准双向口  
   24   1              
   25   1              PCON &= 0x3f;           //波特率不倍速，串行口工作方式由SM0、SM1决定
   26   1              SCON = 0x50;            //8位数据,可变波特率，启动串行接收器
   27   1              AUXR |= 0x40;           //定时器1时钟为Fosc,即1T
   28   1              AUXR &= 0xfe;           //串口1选择定时器1为波特率发生器
   29   1              TMOD &= 0x0f;           //清除定时器1模式位
   30   1              TMOD |= 0x20;           //设定定时器1为8位自动重装方式
   31   1              TL1 = 0xB2;               //设定定时初值
   32   1              TH1 = 0xB2;               //设定定时器重装值
   33   1              ET1 = 0;                    //禁止定时器1中断
   34   1              TR1 = 1;                    //启动定时器1
   35   1              ES = 1;         // 串口1中断打开 
   36   1              
   37   1              EA = 1;               //总中断打开 
   38   1              
   39   1              delay_ms(100);
   40   1      }
   41          
   42          /***************************************************************************
   43           * 描  述 : 串口1发送数据函数
   44           * 入  参 : uint8 数据
   45           * 返回值 : 无
   46           **************************************************************************/
   47          void SendDataByUart1(unsigned char dat)
   48          {
   49   1          SBUF = dat;                 //写数据到UART数据寄存器
   50   1          B_TX1_Busy = 1;
   51   1          while(B_TX1_Busy);                   //清除TI位（该位必须软件清零）
   52   1      } 
   53          /***************************************************************************
   54           * 描  述 : 串口1中断服务函数
   55           * 入  参 : 无
   56           * 返回值 : 无
   57           **************************************************************************/
   58          void Uart1() interrupt 4 using 1
C251 COMPILER V5.60.0,  uart1                                                              18/05/23  11:00:22  PAGE 2   

   59          {
   60   1                ES = 0;                         // 串口1中断关闭
   61   1                if (RI)                     //串行接收到停止位的中间时刻时，该位置1
   62   1         {
   63   2            RI = 0;                 //清除RI位 （该位必须软件清零）SBUF; 
   64   2                        program_automatic_update();         
   65   2         }
   66   1         if (TI)                    //在停止位开始发送时，该位置1
   67   1         {
   68   2            TI = 0;                 //清除TI位（该位必须软件清零） 
   69   2                        B_TX1_Busy = 0;
   70   2         }
   71   1               ES =  1;                   // 串口1中断打开
   72   1      }
   73          //========================================================================
   74          // 函数: void PrintString1(u8 *puts)
   75          // 描述: 串口1发送字符串函数。
   76          // 参数: puts:  字符串指针.
   77          // 返回: none.
   78          // 版本: VER1.0
   79          // 日期: 2022-09-24
   80          // 备注: 
   81          //========================================================================
   82          void PrintString1(unsigned char *puts)
   83          {
   84   1          for (; *puts != 0;  puts++)     //遇到停止符0结束
   85   1          {
   86   2              SBUF = *puts;
   87   2              B_TX1_Busy = 1;
   88   2              while(B_TX1_Busy);
   89   2          }
   90   1      }
   91          //========================================================================
   92          // 函数: void program_automatic_update(void)
   93          // 描述: 程序自动下载。
   94          // 参数: 程序自动下载。.
   95          // 返回: none.
   96          // 版本: VER1.0
   97          // 日期: 2022-09-24
   98          // 备注: 
   99          //======================================================================== 
  100          
  101          void program_automatic_update(void)
  102          {
  103   1          static unsigned char recv_cnt = 0;
  104   1          if (SBUF == 0xAF)
  105   1          {
  106   2              if (++recv_cnt >= 5)
  107   2              {
  108   3                  recv_cnt = 0;
  109   3                  IAP_CONTR = 0x60;   //触发软件复位，从ISP开始执行
  110   3              }
  111   2          }
  112   1          else
  113   1          {
  114   2              recv_cnt = 0;
  115   2          }
  116   1      }
  117           /**************************************************************************
  118          功能描述：串口打印数据
  119          入口参数：无
  120          返回值：无 1236
  121           *************************************************************************/ 
  122          void Uart_Send_ADC_data(unsigned int  ADC_DATA)
  123          {
  124   1                unsigned char temp=0,temp1=0,temp2=0,temp3=0;
C251 COMPILER V5.60.0,  uart1                                                              18/05/23  11:00:22  PAGE 3   

  125   1              
  126   1                   temp=(ADC_DATA/1000)+'0'; 
  127   1                   temp1=(ADC_DATA/100%10)+'0'; 
  128   1                   temp2=(ADC_DATA/10%10)+'0';
  129   1                   temp3=(ADC_DATA%10)+'0';
  130   1      
  131   1                       PrintString1("SR04:");
  132   1                               SendDataByUart1(temp);
  133   1                               SendDataByUart1(temp1 );
  134   1                               SendDataByUart1(temp2);
  135   1                               SendDataByUart1(temp3);                
  136   1                         PrintString1(" CM\r\n");                     
  137   1      }
  138          
  139          
  140          
  141          
  142          
  143          
  144          
  145          
  146          
  147          
  148          
  149          


Module Information          Static   Overlayable
------------------------------------------------
  code size            =       268     ------
  ecode size           =    ------     ------
  data size            =         1     ------
  idata size           =    ------     ------
  pdata size           =    ------     ------
  xdata size           =    ------     ------
  xdata-const size     =    ------     ------
  edata size           =    ------     ------
  bit size             =         1     ------
  ebit size            =    ------     ------
  bitaddressable size  =    ------     ------
  ebitaddressable size =    ------     ------
  far data size        =    ------     ------
  huge data size       =    ------     ------
  const size           =        12     ------
  hconst size          =    ------     ------
End of Module Information.


C251 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
